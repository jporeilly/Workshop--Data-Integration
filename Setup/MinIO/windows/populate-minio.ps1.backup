# ==============================================================================
# MinIO Data Population Script - Sample Data for Pentaho Data Integration
# ==============================================================================
#
# Purpose:
#   Populates MinIO buckets with sample data sources in various formats
#   suitable for onboarding and testing with Pentaho Data Integration (PDI).
#   Creates realistic datasets for ETL development, testing, and training.
#
# Data Sources Created:
#   1. CSV files - Customer, sales, product data
#   2. JSON files - API responses, nested data structures
#   3. Parquet files - Big data format for analytics (if Python available)
#   4. XML files - Legacy system exports
#   5. Text files - Log files, unstructured data
#
# Buckets Created:
#   - raw-data: Landing zone for raw source files
#   - staging: Intermediate processing area
#   - curated: Clean, processed data ready for consumption
#   - logs: Application and process logs
#   - archive: Historical data archives
#
# Requirements:
#   - MinIO running and accessible (localhost:9000)
#   - MinIO Client (mc.exe) installed and in PATH
#   - PowerShell 5.1 or higher
#   - Optional: Python 3 with pandas, pyarrow (for Parquet generation)
#
# Usage:
#   .\populate-minio.ps1
#
# Parameters (optional):
#   -MinIOEndpoint: MinIO endpoint (default: http://localhost:9000)
#   -MinIOUser: MinIO username (default: minioadmin)
#   -MinIOPassword: MinIO password (default: minioadmin)
#   -MinIOAlias: Alias name for mc (default: minio-local)
#
# Exit Codes:
#   0 - Success
#   1 - Error (dependencies missing, MinIO not accessible, etc.)
# ==============================================================================

param(
    [string]$MinIOEndpoint = "http://localhost:9000",
    [string]$MinIOUser = "minioadmin",
    [string]$MinIOPassword = "minioadmin",
    [string]$MinIOAlias = "minio-local"
)

# ------------------------------------------------------------------------------
# Configuration
# ------------------------------------------------------------------------------
$ErrorActionPreference = "Stop"

# Bucket names
$BUCKET_RAW = "raw-data"
$BUCKET_STAGING = "staging"
$BUCKET_CURATED = "curated"
$BUCKET_LOGS = "logs"
$BUCKET_ARCHIVE = "archive"

# Create temporary directory
$TempDir = Join-Path $env:TEMP "minio-populate-$(Get-Date -Format 'yyyyMMddHHmmss')"
New-Item -ItemType Directory -Path $TempDir -Force | Out-Null

# Cleanup function
$CleanupScript = {
    if (Test-Path $TempDir) {
        Remove-Item -Path $TempDir -Recurse -Force -ErrorAction SilentlyContinue
    }
}
Register-EngineEvent -SourceIdentifier PowerShell.Exiting -Action $CleanupScript | Out-Null

# ------------------------------------------------------------------------------
# Display Script Header
# ------------------------------------------------------------------------------
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "MinIO Data Population Script" -ForegroundColor Cyan
Write-Host "Sample Data for Pentaho Data Integration" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

# ------------------------------------------------------------------------------
# Function: Check Dependencies
# ------------------------------------------------------------------------------
function Test-Dependencies {
    Write-Host "[1/8] Checking dependencies..." -ForegroundColor Blue

    $missingDeps = @()

    # Check for MinIO Client
    if (-not (Get-Command mc -ErrorAction SilentlyContinue)) {
        $missingDeps += "mc.exe (MinIO Client)"
    }

    # Check for curl (optional, for connectivity test)
    if (-not (Get-Command curl -ErrorAction SilentlyContinue)) {
        Write-Host "  [WARNING] curl not found - connectivity test will be limited" -ForegroundColor Yellow
    }

    # Check for Python 3 (optional, for Parquet)
    if (-not (Get-Command python -ErrorAction SilentlyContinue)) {
        Write-Host "  [WARNING] python not found - Parquet files will not be generated" -ForegroundColor Yellow
    }

    # Report missing critical dependencies
    if ($missingDeps.Count -gt 0) {
        Write-Host "[ERROR] Missing required dependencies:" -ForegroundColor Red
        foreach ($dep in $missingDeps) {
            Write-Host "  - $dep" -ForegroundColor Red
        }
        Write-Host ""
        Write-Host "Installation instructions:" -ForegroundColor Yellow
        Write-Host "  # MinIO Client:"
        Write-Host "  # Download from: " -NoNewline; Write-Host "https://dl.min.io/client/mc/release/windows-amd64/mc.exe" -ForegroundColor Cyan
        Write-Host "  # Place in PATH (e.g., C:\Windows\System32 or C:\Program Files\MinIO)"
        return $false
    }

    Write-Host "  [OK] All required dependencies found" -ForegroundColor Green
    return $true
}

# ------------------------------------------------------------------------------
# Function: Check MinIO Connectivity
# ------------------------------------------------------------------------------
function Test-MinIOConnectivity {
    Write-Host "[2/8] Checking MinIO connectivity..." -ForegroundColor Blue

    try {
        $healthUrl = "$MinIOEndpoint/minio/health/live"
        $response = Invoke-WebRequest -Uri $healthUrl -TimeoutSec 5 -UseBasicParsing -ErrorAction Stop

        if ($response.StatusCode -eq 200) {
            Write-Host "  [OK] MinIO is accessible at $MinIOEndpoint" -ForegroundColor Green
            return $true
        }
    }
    catch {
        Write-Host "  [ERROR] Cannot connect to MinIO at $MinIOEndpoint" -ForegroundColor Red
        Write-Host "  Please ensure MinIO is running:" -ForegroundColor Yellow
        Write-Host "  " -NoNewline; Write-Host ".\run-docker-minio.ps1" -ForegroundColor Cyan
        return $false
    }
}

# ------------------------------------------------------------------------------
# Function: Configure MinIO Client
# ------------------------------------------------------------------------------
function Set-MinIOClient {
    Write-Host "[3/8] Configuring MinIO Client..." -ForegroundColor Blue

    # Remove existing alias if present
    mc alias remove $MinIOAlias 2>$null

    # Set up MinIO alias
    $result = mc alias set $MinIOAlias $MinIOEndpoint $MinIOUser $MinIOPassword 2>&1

    if ($LASTEXITCODE -ne 0) {
        Write-Host "  [ERROR] Failed to configure MinIO Client" -ForegroundColor Red
        Write-Host "  Check credentials and endpoint" -ForegroundColor Yellow
        return $false
    }

    Write-Host "  [OK] MinIO Client configured with alias: $MinIOAlias" -ForegroundColor Green
    return $true
}

# ------------------------------------------------------------------------------
# Function: Create Buckets
# ------------------------------------------------------------------------------
function New-MinioBuckets {
    Write-Host "[4/8] Creating buckets..." -ForegroundColor Blue

    $buckets = @($BUCKET_RAW, $BUCKET_STAGING, $BUCKET_CURATED, $BUCKET_LOGS, $BUCKET_ARCHIVE)

    foreach ($bucket in $buckets) {
        # Check if bucket exists
        $checkResult = mc ls "${MinIOAlias}/${bucket}" 2>&1

        if ($LASTEXITCODE -eq 0) {
            Write-Host "  [EXISTS] Bucket: $bucket" -ForegroundColor Yellow
        }
        else {
            # Create bucket
            $createResult = mc mb "${MinIOAlias}/${bucket}" 2>&1

            if ($LASTEXITCODE -eq 0) {
                Write-Host "  [CREATED] Bucket: $bucket" -ForegroundColor Green
            }
            else {
                Write-Host "  [ERROR] Failed to create bucket: $bucket" -ForegroundColor Red
                return $false
            }
        }
    }

    return $true
}

# ------------------------------------------------------------------------------
# Function: Generate CSV Files
# ------------------------------------------------------------------------------
function New-CSVFiles {
    Write-Host "[5/8] Generating CSV files..." -ForegroundColor Blue

    # Create customers.csv
    Write-Host "  Generating customers.csv..." -ForegroundColor Cyan
    $customersCSV = @"
customer_id,first_name,last_name,email,phone,country,registration_date,status
1001,John,Smith,john.smith@example.com,555-0101,USA,2023-01-15,active
1002,Maria,Garcia,maria.garcia@example.com,555-0102,Spain,2023-02-20,active
1003,Wei,Chen,wei.chen@example.com,555-0103,China,2023-03-10,active
1004,Sarah,Johnson,sarah.johnson@example.com,555-0104,USA,2023-04-05,active
1005,Mohammed,Ahmed,mohammed.ahmed@example.com,555-0105,UAE,2023-05-12,inactive
1006,Anna,Kowalski,anna.kowalski@example.com,555-0106,Poland,2023-06-18,active
1007,Carlos,Rodriguez,carlos.rodriguez@example.com,555-0107,Mexico,2023-07-22,active
1008,Yuki,Tanaka,yuki.tanaka@example.com,555-0108,Japan,2023-08-30,active
1009,Emma,Brown,emma.brown@example.com,555-0109,UK,2023-09-14,active
1010,Lars,Nielsen,lars.nielsen@example.com,555-0110,Denmark,2023-10-25,active
1011,Priya,Sharma,priya.sharma@example.com,555-0111,India,2023-11-08,inactive
1012,Jean,Dupont,jean.dupont@example.com,555-0112,France,2023-12-03,active
"@
    $customersCSV | Out-File -FilePath "$TempDir\customers.csv" -Encoding UTF8 -NoNewline

    # Create products.csv
    # Extended with 6 additional products (P013-P018) for enhanced Workshop 2 scenarios
    Write-Host "  Generating products.csv..." -ForegroundColor Cyan
    $productsCSV = @"
product_id,product_name,category,price,stock_quantity,supplier,last_updated
P001,Laptop Pro 15,Electronics,1299.99,45,TechSupply Inc,2024-01-15
P002,Wireless Mouse,Electronics,29.99,230,TechSupply Inc,2024-01-16
P003,Office Chair Deluxe,Furniture,349.99,78,ComfortSeats Ltd,2024-01-14
P004,Standing Desk,Furniture,599.99,34,ComfortSeats Ltd,2024-01-13
P005,4K Monitor 27inch,Electronics,459.99,92,DisplayTech Corp,2024-01-17
P006,Mechanical Keyboard,Electronics,129.99,156,TechSupply Inc,2024-01-15
P007,USB-C Hub,Electronics,49.99,310,ConnectPro Inc,2024-01-18
P008,Desk Lamp LED,Furniture,39.99,180,LightWorks Co,2024-01-12
P009,Noise Cancelling Headphones,Electronics,279.99,67,AudioMax Ltd,2024-01-19
P010,Ergonomic Footrest,Furniture,34.99,145,ComfortSeats Ltd,2024-01-11
P011,Webcam HD,Electronics,89.99,201,TechSupply Inc,2024-01-20
P012,Conference Speakerphone,Electronics,199.99,54,AudioMax Ltd,2024-01-16
P013,External SSD 1TB,Electronics,149.99,120,TechSupply Inc,2024-01-21
P014,Bluetooth Trackpad,Electronics,79.99,95,TechSupply Inc,2024-01-22
P015,Monitor Arm Mount,Furniture,89.99,50,ComfortSeats Ltd,2024-01-23
P016,Cable Management Kit,Furniture,24.99,200,LightWorks Co,2024-01-24
P017,Portable Charger,Electronics,39.99,300,ConnectPro Inc,2024-01-25
P018,Laptop Stand,Furniture,54.99,85,ComfortSeats Ltd,2024-01-26
"@
    $productsCSV | Out-File -FilePath "$TempDir\products.csv" -Encoding UTF8 -NoNewline

    # Create sales.csv
    Write-Host "  Generating sales.csv..." -ForegroundColor Cyan
    $salesCSV = @"
sale_id,customer_id,product_id,quantity,sale_date,sale_amount,payment_method,status
S001,1001,P001,1,2024-01-20,1299.99,credit_card,completed
S002,1002,P003,2,2024-01-21,699.98,paypal,completed
S003,1003,P002,1,2024-01-21,29.99,credit_card,completed
S004,1001,P005,1,2024-01-22,459.99,credit_card,completed
S005,1004,P006,1,2024-01-22,129.99,debit_card,completed
S006,1005,P008,3,2024-01-23,119.97,paypal,pending
S007,1006,P009,1,2024-01-23,279.99,credit_card,completed
S008,1007,P004,1,2024-01-24,599.99,credit_card,completed
S009,1008,P007,2,2024-01-24,99.98,paypal,completed
S010,1009,P011,1,2024-01-25,89.99,debit_card,completed
S011,1010,P012,1,2024-01-25,199.99,credit_card,completed
S012,1002,P010,4,2024-01-26,139.96,paypal,completed
S013,1003,P001,1,2024-01-26,1299.99,credit_card,processing
S014,1011,P005,2,2024-01-27,919.98,credit_card,cancelled
S015,1012,P002,3,2024-01-27,89.97,paypal,completed
"@
    $salesCSV | Out-File -FilePath "$TempDir\sales.csv" -Encoding UTF8 -NoNewline

    # Upload CSV files to MinIO
    Write-Host "  Uploading CSV files to MinIO..." -ForegroundColor Cyan
    mc cp "$TempDir\customers.csv" "${MinIOAlias}/${BUCKET_RAW}/csv/" | Out-Null
    mc cp "$TempDir\products.csv" "${MinIOAlias}/${BUCKET_RAW}/csv/" | Out-Null
    mc cp "$TempDir\sales.csv" "${MinIOAlias}/${BUCKET_RAW}/csv/" | Out-Null

    Write-Host "  [OK] CSV files generated and uploaded" -ForegroundColor Green
}

# ------------------------------------------------------------------------------
# Function: Generate JSON Files
# ------------------------------------------------------------------------------
function New-JSONFiles {
    Write-Host "[6/8] Generating JSON files..." -ForegroundColor Blue

    # Create api_response.json
    Write-Host "  Generating api_response.json..." -ForegroundColor Cyan
    $apiResponseJSON = @"
{
  "status": "success",
  "timestamp": "2024-01-23T10:30:00Z",
  "data": {
    "orders": [
      {
        "order_id": "ORD-2024-001",
        "customer": {
          "id": 1001,
          "name": "John Smith",
          "email": "john.smith@example.com"
        },
        "items": [
          {
            "product_id": "P001",
            "name": "Laptop Pro 15",
            "quantity": 1,
            "unit_price": 1299.99
          }
        ],
        "total": 1299.99,
        "order_date": "2024-01-20T14:30:00Z",
        "shipping_address": {
          "street": "123 Main St",
          "city": "New York",
          "state": "NY",
          "zip": "10001",
          "country": "USA"
        }
      },
      {
        "order_id": "ORD-2024-002",
        "customer": {
          "id": 1002,
          "name": "Maria Garcia",
          "email": "maria.garcia@example.com"
        },
        "items": [
          {
            "product_id": "P003",
            "name": "Office Chair Deluxe",
            "quantity": 2,
            "unit_price": 349.99
          }
        ],
        "total": 699.98,
        "order_date": "2024-01-21T09:15:00Z",
        "shipping_address": {
          "street": "456 Gran Via",
          "city": "Madrid",
          "state": "Madrid",
          "zip": "28013",
          "country": "Spain"
        }
      }
    ],
    "pagination": {
      "page": 1,
      "per_page": 10,
      "total_pages": 1,
      "total_records": 2
    }
  }
}
"@
    $apiResponseJSON | Out-File -FilePath "$TempDir\api_response.json" -Encoding UTF8 -NoNewline

    # Create user_events.json (JSONL format)
    Write-Host "  Generating user_events.json..." -ForegroundColor Cyan
    $userEventsJSON = @"
{"event_id":"evt_001","user_id":1001,"event_type":"page_view","page":"/products","timestamp":"2024-01-23T08:00:00Z","session_id":"sess_abc123"}
{"event_id":"evt_002","user_id":1001,"event_type":"add_to_cart","product_id":"P001","timestamp":"2024-01-23T08:05:00Z","session_id":"sess_abc123"}
{"event_id":"evt_003","user_id":1002,"event_type":"page_view","page":"/home","timestamp":"2024-01-23T08:10:00Z","session_id":"sess_def456"}
{"event_id":"evt_004","user_id":1001,"event_type":"checkout","cart_value":1299.99,"timestamp":"2024-01-23T08:15:00Z","session_id":"sess_abc123"}
{"event_id":"evt_005","user_id":1003,"event_type":"search","query":"wireless mouse","timestamp":"2024-01-23T08:20:00Z","session_id":"sess_ghi789"}
{"event_id":"evt_006","user_id":1002,"event_type":"add_to_cart","product_id":"P003","timestamp":"2024-01-23T08:25:00Z","session_id":"sess_def456"}
{"event_id":"evt_007","user_id":1004,"event_type":"page_view","page":"/products/electronics","timestamp":"2024-01-23T08:30:00Z","session_id":"sess_jkl012"}
{"event_id":"evt_008","user_id":1003,"event_type":"product_view","product_id":"P002","timestamp":"2024-01-23T08:35:00Z","session_id":"sess_ghi789"}
"@
    $userEventsJSON | Out-File -FilePath "$TempDir\user_events.json" -Encoding UTF8 -NoNewline

    # Create config.json
    Write-Host "  Generating config.json..." -ForegroundColor Cyan
    $configJSON = @"
{
  "application": {
    "name": "DataIntegrationPipeline",
    "version": "1.0.0",
    "environment": "production"
  },
  "database": {
    "host": "db.example.com",
    "port": 5432,
    "name": "analytics_db",
    "connection_pool": {
      "min": 5,
      "max": 20,
      "timeout": 30000
    }
  },
  "s3_storage": {
    "endpoint": "http://localhost:9000",
    "buckets": {
      "raw": "raw-data",
      "staging": "staging",
      "curated": "curated"
    }
  },
  "processing": {
    "batch_size": 1000,
    "max_retries": 3,
    "timeout_seconds": 300
  }
}
"@
    $configJSON | Out-File -FilePath "$TempDir\config.json" -Encoding UTF8 -NoNewline

    # Upload JSON files to MinIO
    Write-Host "  Uploading JSON files to MinIO..." -ForegroundColor Cyan
    mc cp "$TempDir\api_response.json" "${MinIOAlias}/${BUCKET_RAW}/json/" | Out-Null
    mc cp "$TempDir\user_events.json" "${MinIOAlias}/${BUCKET_RAW}/json/" | Out-Null
    mc cp "$TempDir\config.json" "${MinIOAlias}/${BUCKET_RAW}/json/" | Out-Null

    Write-Host "  [OK] JSON files generated and uploaded" -ForegroundColor Green
}

# ------------------------------------------------------------------------------
# Function: Generate XML Files
# ------------------------------------------------------------------------------
function New-XMLFiles {
    Write-Host "[7/8] Generating XML files..." -ForegroundColor Blue

    # Create inventory.xml
    # Enhanced inventory with 13 warehouse items demonstrating diverse reconciliation scenarios:
    # PERFECT MATCHES (3): warehouse = catalog
    # MINOR OVERSTOCK (2): warehouse 1-10 units over
    # MAJOR OVERSTOCK (2): warehouse significantly over
    # MINOR UNDERSTOCK (2): warehouse 1-10 units short
    # MAJOR UNDERSTOCK (2): warehouse significantly short
    # CRITICAL UNDERSTOCK (1): warehouse severely depleted
    # MISSING IN CATALOG (1): warehouse has item not in catalog
    # MISSING IN WAREHOUSE (6): catalog items not tracked in warehouse
    Write-Host "  Generating inventory.xml..." -ForegroundColor Cyan
    $inventoryXML = @"
<?xml version="1.0" encoding="UTF-8"?>
<inventory>
    <metadata>
        <export_date>2024-01-23</export_date>
        <warehouse>Main Warehouse</warehouse>
        <location>New York, NY</location>
        <system>WarehouseManagementSystem v2.3</system>
        <last_full_count>2024-01-15</last_full_count>
    </metadata>
    <items>
        <!-- ========== PERFECT MATCHES (3 items) ========== -->

        <item>
            <sku>P001</sku>
            <name>Laptop Pro 15</name>
            <category>Electronics</category>
            <quantity>45</quantity>
            <location>A-12-3</location>
            <last_checked>2024-01-20</last_checked>
            <status>PERFECT MATCH - No action needed</status>
        </item>

        <item>
            <sku>P004</sku>
            <name>Standing Desk</name>
            <category>Furniture</category>
            <quantity>34</quantity>
            <location>C-10-2</location>
            <last_checked>2024-01-22</last_checked>
            <status>PERFECT MATCH - No action needed</status>
        </item>

        <item>
            <sku>P017</sku>
            <name>Portable Charger</name>
            <category>Electronics</category>
            <quantity>300</quantity>
            <location>A-20-1</location>
            <last_checked>2024-01-23</last_checked>
            <status>PERFECT MATCH - No action needed</status>
        </item>

        <!-- ========== MINOR OVERSTOCK (2 items, +5 each) ========== -->

        <item>
            <sku>P013</sku>
            <name>External SSD 1TB</name>
            <category>Electronics</category>
            <quantity>125</quantity>
            <location>A-18-2</location>
            <last_checked>2024-01-21</last_checked>
            <status>MINOR OVERSTOCK +5 - Low priority, monitor</status>
        </item>

        <item>
            <sku>P016</sku>
            <name>Cable Management Kit</name>
            <category>Furniture</category>
            <quantity>205</quantity>
            <location>C-15-3</location>
            <last_checked>2024-01-24</last_checked>
            <status>MINOR OVERSTOCK +5 - Low priority, monitor</status>
        </item>

        <!-- ========== MAJOR OVERSTOCK (2 items) ========== -->

        <item>
            <sku>P002</sku>
            <name>Wireless Mouse</name>
            <category>Electronics</category>
            <quantity>250</quantity>
            <location>B-05-1</location>
            <last_checked>2024-01-21</last_checked>
            <status>MAJOR OVERSTOCK +20 - Review ordering, possible excess inventory</status>
        </item>

        <item>
            <sku>P006</sku>
            <name>Mechanical Keyboard</name>
            <category>Electronics</category>
            <quantity>200</quantity>
            <location>A-15-2</location>
            <last_checked>2024-01-20</last_checked>
            <status>MAJOR OVERSTOCK +44 - Investigate cause, adjust ordering</status>
        </item>

        <!-- ========== MINOR UNDERSTOCK (2 items) ========== -->

        <item>
            <sku>P014</sku>
            <name>Bluetooth Trackpad</name>
            <category>Electronics</category>
            <quantity>90</quantity>
            <location>A-19-1</location>
            <last_checked>2024-01-22</last_checked>
            <status>MINOR UNDERSTOCK -5 - Monitor closely</status>
        </item>

        <item>
            <sku>P015</sku>
            <name>Monitor Arm Mount</name>
            <category>Furniture</category>
            <quantity>48</quantity>
            <location>C-12-4</location>
            <last_checked>2024-01-23</last_checked>
            <status>MINOR UNDERSTOCK -2 - Monitor closely</status>
        </item>

        <!-- ========== MAJOR UNDERSTOCK (2 items) ========== -->

        <item>
            <sku>P003</sku>
            <name>Office Chair Deluxe</name>
            <category>Furniture</category>
            <quantity>60</quantity>
            <location>C-08-4</location>
            <last_checked>2024-01-19</last_checked>
            <status>MAJOR UNDERSTOCK -18 - Reorder soon</status>
        </item>

        <item>
            <sku>P007</sku>
            <name>USB-C Hub</name>
            <category>Electronics</category>
            <quantity>280</quantity>
            <location>B-03-5</location>
            <last_checked>2024-01-22</last_checked>
            <status>MAJOR UNDERSTOCK -30 - Reorder soon</status>
        </item>

        <!-- ========== CRITICAL UNDERSTOCK (1 item) ========== -->

        <item>
            <sku>P018</sku>
            <name>Laptop Stand</name>
            <category>Furniture</category>
            <quantity>15</quantity>
            <location>C-14-2</location>
            <last_checked>2024-01-26</last_checked>
            <status>CRITICAL UNDERSTOCK -70 (82% shortage!) - URGENT REORDER NEEDED</status>
        </item>

        <!-- ========== MISSING IN CATALOG (1 item) ========== -->

        <item>
            <sku>P099</sku>
            <name>Legacy Tablet (Discontinued)</name>
            <category>Electronics</category>
            <quantity>12</quantity>
            <location>D-01-1</location>
            <last_checked>2024-01-15</last_checked>
            <status>ORPHAN - Not in catalog, clearance needed</status>
        </item>

        <!-- Note: P005, P008, P009, P010, P011, P012 are in catalog but NOT tracked in warehouse -->
        <!-- These create MISSING_IN_WAREHOUSE scenarios - warehouse has no record of these items -->
    </items>
</inventory>
"@
    $inventoryXML | Out-File -FilePath "$TempDir\inventory.xml" -Encoding UTF8 -NoNewline

    # Create employees.xml
    Write-Host "  Generating employees.xml..." -ForegroundColor Cyan
    $employeesXML = @"
<?xml version="1.0" encoding="UTF-8"?>
<company>
    <department name="Sales">
        <employee id="E001">
            <name>Alice Johnson</name>
            <position>Sales Manager</position>
            <email>alice.johnson@company.com</email>
            <hire_date>2020-03-15</hire_date>
            <salary currency="USD">85000</salary>
        </employee>
        <employee id="E002">
            <name>Bob Williams</name>
            <position>Sales Representative</position>
            <email>bob.williams@company.com</email>
            <hire_date>2021-06-01</hire_date>
            <salary currency="USD">55000</salary>
        </employee>
    </department>
    <department name="Engineering">
        <employee id="E003">
            <name>Carol Martinez</name>
            <position>Senior Developer</position>
            <email>carol.martinez@company.com</email>
            <hire_date>2019-01-10</hire_date>
            <salary currency="USD">105000</salary>
        </employee>
        <employee id="E004">
            <name>David Lee</name>
            <position>DevOps Engineer</position>
            <email>david.lee@company.com</email>
            <hire_date>2022-08-20</hire_date>
            <salary currency="USD">95000</salary>
        </employee>
    </department>
</company>
"@
    $employeesXML | Out-File -FilePath "$TempDir\employees.xml" -Encoding UTF8 -NoNewline

    # Upload XML files to MinIO
    Write-Host "  Uploading XML files to MinIO..." -ForegroundColor Cyan
    mc cp "$TempDir\inventory.xml" "${MinIOAlias}/${BUCKET_RAW}/xml/" | Out-Null
    mc cp "$TempDir\employees.xml" "${MinIOAlias}/${BUCKET_RAW}/xml/" | Out-Null

    Write-Host "  [OK] XML files generated and uploaded" -ForegroundColor Green
}

# ------------------------------------------------------------------------------
# Function: Generate Log Files
# ------------------------------------------------------------------------------
function New-LogFiles {
    Write-Host "[8/8] Generating log files..." -ForegroundColor Blue

    # Create application.log
    Write-Host "  Generating application.log..." -ForegroundColor Cyan
    $applicationLog = @"
2024-01-23 08:00:01 INFO  [main] Application started successfully
2024-01-23 08:00:02 INFO  [scheduler] Scheduled job 'DataSync' initialized
2024-01-23 08:00:05 INFO  [database] Database connection pool created (size: 10)
2024-01-23 08:05:10 INFO  [api] Processing request: GET /api/customers?page=1
2024-01-23 08:05:11 INFO  [api] Request completed in 234ms
2024-01-23 08:10:15 WARN  [cache] Cache miss for key: customer_1001
2024-01-23 08:10:16 INFO  [database] Query executed: SELECT * FROM customers WHERE id = 1001
2024-01-23 08:15:20 INFO  [etl] Starting ETL job: DailyCustomerSync
2024-01-23 08:15:21 INFO  [etl] Extracted 1250 records from source
2024-01-23 08:15:45 INFO  [etl] Transformed 1250 records
2024-01-23 08:16:10 INFO  [etl] Loaded 1250 records to target
2024-01-23 08:16:11 INFO  [etl] ETL job completed successfully (duration: 51s)
2024-01-23 08:20:30 ERROR [api] Failed to process request: Connection timeout
2024-01-23 08:20:30 ERROR [api] Stack trace: ConnectionTimeoutException at line 145
2024-01-23 08:20:31 WARN  [api] Retrying request (attempt 1 of 3)
2024-01-23 08:20:35 INFO  [api] Request retry successful
2024-01-23 08:25:40 INFO  [scheduler] Executing scheduled job: HourlyReportGeneration
2024-01-23 08:26:15 INFO  [report] Report generated: sales_summary_2024-01-23.pdf
2024-01-23 08:30:00 INFO  [cleanup] Starting cleanup of temporary files
2024-01-23 08:30:05 INFO  [cleanup] Removed 127 temporary files (freed 2.3 GB)
"@
    $applicationLog | Out-File -FilePath "$TempDir\application.log" -Encoding UTF8 -NoNewline

    # Create access.log
    Write-Host "  Generating access.log..." -ForegroundColor Cyan
    $accessLog = @"
192.168.1.100 - - [23/Jan/2024:08:00:01 +0000] "GET /api/health HTTP/1.1" 200 15 "-" "HealthCheckBot/1.0"
192.168.1.105 - user1 [23/Jan/2024:08:05:10 +0000] "GET /api/customers?page=1 HTTP/1.1" 200 4523 "-" "Mozilla/5.0"
192.168.1.105 - user1 [23/Jan/2024:08:05:45 +0000] "GET /api/products?category=electronics HTTP/1.1" 200 8734 "-" "Mozilla/5.0"
192.168.1.110 - user2 [23/Jan/2024:08:10:20 +0000] "POST /api/orders HTTP/1.1" 201 1245 "-" "Mozilla/5.0"
192.168.1.115 - - [23/Jan/2024:08:15:30 +0000] "GET /api/reports/daily HTTP/1.1" 200 15678 "-" "Python/3.9"
192.168.1.105 - user1 [23/Jan/2024:08:20:15 +0000] "PUT /api/customers/1001 HTTP/1.1" 200 876 "-" "Mozilla/5.0"
192.168.1.120 - admin [23/Jan/2024:08:25:00 +0000] "GET /admin/dashboard HTTP/1.1" 200 23456 "-" "Mozilla/5.0"
192.168.1.125 - - [23/Jan/2024:08:30:10 +0000] "GET /api/invalid-endpoint HTTP/1.1" 404 234 "-" "curl/7.68.0"
192.168.1.110 - user2 [23/Jan/2024:08:35:20 +0000] "DELETE /api/cart/items/123 HTTP/1.1" 204 0 "-" "Mozilla/5.0"
192.168.1.130 - user3 [23/Jan/2024:08:40:30 +0000] "GET /api/products/search?q=laptop HTTP/1.1" 200 5432 "-" "Mozilla/5.0"
"@
    $accessLog | Out-File -FilePath "$TempDir\access.log" -Encoding UTF8 -NoNewline

    # Create error.log
    Write-Host "  Generating error.log..." -ForegroundColor Cyan
    $errorLog = @"
[2024-01-23 08:20:30] ERROR: Database connection failed - Connection refused (ECONNREFUSED)
[2024-01-23 08:20:30] Stack: at TCPConnectWrap.afterConnect [as oncomplete] (net.js:1148:16)
[2024-01-23 08:35:45] WARNING: API rate limit exceeded for IP: 192.168.1.150
[2024-01-23 08:42:10] ERROR: File not found - /data/imports/missing_file.csv
[2024-01-23 09:15:20] ERROR: Authentication failed for user: invalid_user
[2024-01-23 09:30:00] WARNING: Disk space low on volume /mnt/data (85% used)
[2024-01-23 09:45:30] ERROR: JSON parse error in file: api_response.json at line 45
[2024-01-23 10:00:15] WARNING: Slow query detected: SELECT * FROM large_table (duration: 15.3s)
"@
    $errorLog | Out-File -FilePath "$TempDir\error.log" -Encoding UTF8 -NoNewline

    # Upload log files to MinIO
    Write-Host "  Uploading log files to MinIO..." -ForegroundColor Cyan
    mc cp "$TempDir\application.log" "${MinIOAlias}/${BUCKET_LOGS}/app/" | Out-Null
    mc cp "$TempDir\access.log" "${MinIOAlias}/${BUCKET_LOGS}/web/" | Out-Null
    mc cp "$TempDir\error.log" "${MinIOAlias}/${BUCKET_LOGS}/error/" | Out-Null

    Write-Host "  [OK] Log files generated and uploaded" -ForegroundColor Green
}

# ------------------------------------------------------------------------------
# Function: Display Summary
# ------------------------------------------------------------------------------
function Show-Summary {
    Write-Host ""
    Write-Host "========================================" -ForegroundColor Green
    Write-Host "Data Population Complete!" -ForegroundColor Green
    Write-Host "========================================" -ForegroundColor Green
    Write-Host ""

    Write-Host "Buckets created:" -ForegroundColor Cyan
    Write-Host "  " -NoNewline; Write-Host "✓" -ForegroundColor Green -NoNewline; Write-Host " $BUCKET_RAW - Raw data landing zone"
    Write-Host "  " -NoNewline; Write-Host "✓" -ForegroundColor Green -NoNewline; Write-Host " $BUCKET_STAGING - Staging area for transformations"
    Write-Host "  " -NoNewline; Write-Host "✓" -ForegroundColor Green -NoNewline; Write-Host " $BUCKET_CURATED - Curated, processed data"
    Write-Host "  " -NoNewline; Write-Host "✓" -ForegroundColor Green -NoNewline; Write-Host " $BUCKET_LOGS - Application and process logs"
    Write-Host "  " -NoNewline; Write-Host "✓" -ForegroundColor Green -NoNewline; Write-Host " $BUCKET_ARCHIVE - Historical data archives"
    Write-Host ""

    Write-Host "Data files uploaded:" -ForegroundColor Cyan
    Write-Host "  CSV Files:" -ForegroundColor Magenta
    Write-Host "    - customers.csv (12 records)"
    Write-Host "    - products.csv (12 records)"
    Write-Host "    - sales.csv (15 records)"
    Write-Host ""
    Write-Host "  JSON Files:" -ForegroundColor Magenta
    Write-Host "    - api_response.json (nested API response)"
    Write-Host "    - user_events.json (event stream, JSONL format)"
    Write-Host "    - config.json (configuration data)"
    Write-Host ""
    Write-Host "  XML Files:" -ForegroundColor Magenta
    Write-Host "    - inventory.xml (warehouse inventory)"
    Write-Host "    - employees.xml (HR data)"
    Write-Host ""
    Write-Host "  Log Files:" -ForegroundColor Magenta
    Write-Host "    - application.log (application logs)"
    Write-Host "    - access.log (web access logs)"
    Write-Host "    - error.log (error logs)"
    Write-Host ""

    $consoleUrl = $MinIOEndpoint -replace '9000', '9002'
    Write-Host "Access MinIO Console:" -ForegroundColor Cyan
    Write-Host "  URL: $consoleUrl"
    Write-Host "  User: $MinIOUser"
    Write-Host ""

    Write-Host "Next Steps for Pentaho Data Integration:" -ForegroundColor Cyan
    Write-Host "  1. Configure VFS S3 connection in PDI:"
    Write-Host "     Endpoint: " -NoNewline; Write-Host "$MinIOEndpoint" -ForegroundColor Cyan
    Write-Host "     Access Key: " -NoNewline; Write-Host "$MinIOUser" -ForegroundColor Cyan
    Write-Host "     Secret Key: " -NoNewline; Write-Host "$MinIOPassword" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "  2. Create transformations to read from buckets:"
    Write-Host "     " -NoNewline; Write-Host "s3a://${BUCKET_RAW}/csv/customers.csv" -ForegroundColor Cyan
    Write-Host "     " -NoNewline; Write-Host "s3a://${BUCKET_RAW}/json/api_response.json" -ForegroundColor Cyan
    Write-Host "     " -NoNewline; Write-Host "s3a://${BUCKET_RAW}/xml/inventory.xml" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "  3. Explore data using MinIO Client:"
    Write-Host "     " -NoNewline; Write-Host "mc ls ${MinIOAlias}/${BUCKET_RAW} --recursive" -ForegroundColor Cyan
    Write-Host ""
}

# ------------------------------------------------------------------------------
# Main Execution
# ------------------------------------------------------------------------------
try {
    # Step 1: Check dependencies
    if (-not (Test-Dependencies)) {
        exit 1
    }
    Write-Host ""

    # Step 2: Check MinIO connectivity
    if (-not (Test-MinIOConnectivity)) {
        exit 1
    }
    Write-Host ""

    # Step 3: Configure MinIO Client
    if (-not (Set-MinIOClient)) {
        exit 1
    }
    Write-Host ""

    # Step 4: Create buckets
    if (-not (New-MinioBuckets)) {
        exit 1
    }
    Write-Host ""

    # Step 5: Generate and upload CSV files
    New-CSVFiles
    Write-Host ""

    # Step 6: Generate and upload JSON files
    New-JSONFiles
    Write-Host ""

    # Step 7: Generate and upload XML files
    New-XMLFiles
    Write-Host ""

    # Step 8: Generate and upload log files
    New-LogFiles
    Write-Host ""

    # Display summary
    Show-Summary

    exit 0
}
catch {
    Write-Host ""
    Write-Host "========================================" -ForegroundColor Red
    Write-Host "Error occurred:" -ForegroundColor Red
    Write-Host $_.Exception.Message -ForegroundColor Red
    Write-Host "========================================" -ForegroundColor Red
    exit 1
}
finally {
    # Cleanup temporary directory
    & $CleanupScript
}
